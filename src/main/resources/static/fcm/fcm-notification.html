<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Token Fetch</title>
</head>
<body>
<h1>FCM Token Fetch Example</h1>
<button id="getTokenButton">Get FCM Token</button>
<p id="tokenDisplay"></p>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-messaging.js";

    // Firebase 설정
    const firebaseConfig = {
        apiKey: "AIzaSyBCHjGjYjeHJ_BfnYr6971MNAmLmedWKa8",
        authDomain: "early-table-6315a.firebaseapp.com",
        projectId: "early-table-6315a",
        storageBucket: "early-table-6315a.firebasestorage.app",
        messagingSenderId: "531693985268",
        appId: "1:531693985268:web:404dd20c73d5d90e416da1",
        measurementId: "G-2K9VLFMZK3"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // 서비스 워커 등록 먼저 처리
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then(function(registration) {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch(function(error) {
            console.log('Service Worker registration failed:', error);
        });
    }

    // FCM 토큰 가져오기
    document.getElementById('getTokenButton').addEventListener('click', async () => {
        try {
            // 알림 권한 요청
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') {
                alert('Notification permission not granted!');
                return;
            }

            const jwtToken = localStorage.getItem('jwtToken');
            if (!jwtToken) {
                alert('로그인이 필요합니다.');
                return;
            }

            // FCM 토큰 가져오기
            const token = await getToken(messaging, {
                vapidKey: 'BCblvSlG7R-AcUqBwKPEUyVpo-p--PinoJY6h_gNyqwY9l6uk1WyEetuKA77hwR3M_REhJ0ckgc9Jm3yuHiNmy0'
            });
            if (token) {
                document.getElementById('tokenDisplay').textContent = `FCM Token: ${token}`;
                console.log('FCM Token:', token);
                // 서버로 토큰 전송
                console.log(JSON.stringify({ token }));
                await fetch('/fcm/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json',
                               'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify({ token })
                });

                if (jwtToken) {
                    console.log('JWT Token:', jwtToken);
                } else {
                    console.log('JWT Token not found.');
                }

                alert('Token sent to server!');
            } else {
                console.log('No registration token available.');
            }
        } catch (error) {
            console.error('Error fetching FCM token:', error);
        }
    });

    // 포그라운드에서 메시지 수신
    onMessage(messaging, (payload) => {
        console.log('Message received. ', payload);
        const notificationTitle = payload.notification.title;
        const notificationOptions = {
            body: payload.notification.body,
            icon: payload.notification.icon
        };

        // 알림 표시
        new Notification(payload.notification.title, {
            body: payload.notification.body});
        console.log('렛 노티피 했음');
    });
</script>
</body>
</html>
